<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DebtGuardianAgentic - Technical Debt Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head> 
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <div id="app">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <!-- Logo and Title Section -->
                    <div class="flex items-center space-x-3">
                        <!-- Logo -->
                        <img src="logo_DebtGuardianAI.png" alt="DebtGuardianAgentic Logo" class="w-28 h-28 rounded-lg" />
                        <!-- Title -->
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">
                                DebtGuardian<span class="text-blue-600">Agentic</span>
                            </h1>
                            <p class="text-sm text-slate-500">LLM-Powered Multi-Agent Technical Debt Detection</p>
                        </div>
                    </div>

                    <!-- Configuration Panel Toggle Button -->
                    <button onclick="toggleConfig()" class="flex items-center space-x-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span class="text-sm font-medium">Configuration</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-6 py-8">
            <!-- Configuration Panel (Hidden by default) -->
            <div id="configPanel" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6 border border-slate-200">
                <h2 class="text-lg font-semibold mb-4">Analysis Configuration</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" id="enableClass" checked class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm text-slate-700">Enable Class-Level Detection</span>
                    </label>
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" id="enableMethod" checked class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm text-slate-700">Enable Method-Level Detection</span>
                    </label>
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" id="enableExplanations" checked class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm text-slate-700">Generate Explanations</span>
                    </label>
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" id="enableFixes" class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm text-slate-700">Generate Fix Suggestions</span>
                    </label>
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" id="applyProgramSlicing" checked class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm text-slate-700">Apply Program Slicing</span>
                    </label>
                    <div class="col-span-2">
                        <label class="block text-sm text-slate-700 mb-2">
                            Minimum Confidence: <span id="confidenceValue">0.5</span>
                        </label>
                        <input type="range" id="minConfidence" min="0" max="1" step="0.1" value="0.5" class="w-full">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Upload Panel -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
                        <h2 class="text-lg font-semibold mb-4">Upload Your Code</h2>
                        
                        <!-- Upload Type Selector -->
                        <div class="flex space-x-2 mb-4">
                            <button id="btnUploadFiles" onclick="switchUploadMode('files')" class="flex-1 py-2 px-3 text-sm font-medium rounded-lg bg-blue-600 text-white">
                                Files
                            </button>
                            <button id="btnUploadFolder" onclick="switchUploadMode('folder')" class="flex-1 py-2 px-3 text-sm font-medium rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300">
                                Folder
                            </button>
                        </div>

                        <!-- File Upload Area -->
                        <div id="fileUploadArea">
                            <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer bg-slate-50">
                                <input type="file" multiple accept=".java,.cpp,.cs,.py,.js" id="fileInput" class="hidden" onchange="handleFileSelect(event)">
                                <label for="fileInput" class="cursor-pointer">
                                    <svg class="w-12 h-12 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                    </svg>
                                    <p class="text-sm text-slate-600 font-medium">Drop files here or click to upload</p>
                                    <p class="text-xs text-slate-400 mt-1">Supported: .java, .cpp, .cs, .py, .js</p>
                                </label>
                            </div>
                        </div>

                        <!-- Folder Upload Area (Hidden by default) -->
                        <div id="folderUploadArea" class="hidden">
                            <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer bg-slate-50">
                                <input type="file" webkitdirectory directory multiple id="folderInput" class="hidden" onchange="handleFolderSelect(event)">
                                <label for="folderInput" class="cursor-pointer">
                                    <svg class="w-12 h-12 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                    </svg>
                                    <p class="text-sm text-slate-600 font-medium">Click to select a project folder</p>
                                    <p class="text-xs text-slate-400 mt-1">All supported files will be analyzed</p>
                                </label>
                            </div>
                        </div>

                        <!-- File List Display -->
                        <div id="fileList" class="mt-4 hidden">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-medium text-slate-700">
                                    <span id="fileCount">0</span> file(s) selected
                                </p>
                                <button onclick="clearFiles()" class="text-xs text-red-600 hover:text-red-700 font-medium">
                                    Clear all
                                </button>
                            </div>
                            <div id="files" class="max-h-32 overflow-y-auto space-y-1"></div>
                        </div>

                        <!-- Analyze Button -->
                        <button onclick="analyzeFiles()" id="analyzeBtn" disabled 
                                class="w-full mt-4 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>Start Analysis</span>
                        </button>
                    </div>

                    <!-- Info Card --> 
                    <div class="bg-blue-50 rounded-xl p-4 border border-blue-200"> 
                        <div class="flex items-start space-x-2"> 
                            <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/> 
                            </svg> 
                            <div class="text-sm text-blue-800"> 
                                <p class="font-medium mb-1">Code Smells in Focus:</p> 
                                <div class="space-y-2"> 
                                    <div class="category-section"> 
                                        <p class="font-medium text-slate-700 mb-1">Class-Level:</p> 
                                        <ul class="space-y-1 text-xs" id="classSmellsList"></ul> 
                                    </div> 
                                    <div class="category-section"> 
                                        <p class="font-medium text-slate-700 mb-1">Method-Level:</p> 
                                        <ul class="space-y-1 text-xs" id="methodSmellsList"></ul> 
                                    </div> 
                                    <div class="category-section"> 
                                        <p class="font-medium text-slate-700 mb-1">Other:</p> 
                                        <ul class="space-y-1 text-xs" id="otherSmellsList"></ul> 
                                    </div> 
                                    <div class="category-section"> 
                                        <p class="font-medium text-slate-700 mb-1">Security:</p> 
                                        <ul class="space-y-1 text-xs" id="securitySmellsList"></ul> 
                                    </div> 
                                </div>
                            </div> 
                        </div> 
                    </div> 
                </div>

                <!-- Results Panel --> 
                <div class="lg:col-span-2"> 
                    <div id="resultsPanel"></div> 
                </div> 
            </div> 
        </div> 
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let selectedFiles = [];
        let sessionId = null;
        let uploadMode = 'files'; // 'files' or 'folder'

        // Supported file extensions
        const SUPPORTED_EXTENSIONS = ['.java', '.cpp', '.cs', '.py', '.js'];

        // Configuration
        document.getElementById('minConfidence').addEventListener('input', (e) => {
            document.getElementById('confidenceValue').textContent = e.target.value;
        });

        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            panel.classList.toggle('hidden');
        }

        function switchUploadMode(mode) {
            uploadMode = mode;
            const fileUploadArea = document.getElementById('fileUploadArea');
            const folderUploadArea = document.getElementById('folderUploadArea');
            const btnUploadFiles = document.getElementById('btnUploadFiles');
            const btnUploadFolder = document.getElementById('btnUploadFolder');

            if (mode === 'files') {
                fileUploadArea.classList.remove('hidden');
                folderUploadArea.classList.add('hidden');
                btnUploadFiles.className = 'flex-1 py-2 px-3 text-sm font-medium rounded-lg bg-blue-600 text-white';
                btnUploadFolder.className = 'flex-1 py-2 px-3 text-sm font-medium rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300';
            } else {
                fileUploadArea.classList.add('hidden');
                folderUploadArea.classList.remove('hidden');
                btnUploadFiles.className = 'flex-1 py-2 px-3 text-sm font-medium rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300';
                btnUploadFolder.className = 'flex-1 py-2 px-3 text-sm font-medium rounded-lg bg-blue-600 text-white';
            }

            // Clear selection when switching modes
            clearFiles();
        }

        function isValidFile(filename) {
            return SUPPORTED_EXTENSIONS.some(ext => filename.toLowerCase().endsWith(ext));
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            selectedFiles = files.filter(file => isValidFile(file.name));
            
            if (selectedFiles.length !== files.length) {
                const skipped = files.length - selectedFiles.length;
                alert(`${skipped} file(s) skipped (unsupported format). Only ${SUPPORTED_EXTENSIONS.join(', ')} files are supported.`);
            }

            displayFiles();
            document.getElementById('analyzeBtn').disabled = selectedFiles.length === 0;
        }

        function handleFolderSelect(event) {
            const files = Array.from(event.target.files);
            selectedFiles = files.filter(file => isValidFile(file.name));
            
            if (selectedFiles.length === 0) {
                alert(`No supported files found in the selected folder. Supported formats: ${SUPPORTED_EXTENSIONS.join(', ')}`);
            } else if (selectedFiles.length !== files.length) {
                const skipped = files.length - selectedFiles.length;
                console.log(`${skipped} file(s) skipped (unsupported format)`);
            }

            displayFiles();
            document.getElementById('analyzeBtn').disabled = selectedFiles.length === 0;
        }

        function displayFiles() {
            const fileList = document.getElementById('fileList');
            const filesDiv = document.getElementById('files');
            const fileCount = document.getElementById('fileCount');
            
            if (selectedFiles.length > 0) {
                fileList.classList.remove('hidden');
                fileCount.textContent = selectedFiles.length;

                // Group files by extension
                const filesByType = {};
                selectedFiles.forEach(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (!filesByType[ext]) filesByType[ext] = [];
                    filesByType[ext].push(file);
                });

                // Display files grouped by type
                let html = '';
                Object.keys(filesByType).sort().forEach(ext => {
                    html += `<div class="mb-2">
                        <div class="text-xs font-medium text-slate-500 mb-1">.${ext} files (${filesByType[ext].length})</div>`;
                    
                    filesByType[ext].forEach(file => {
                        const fileIcon = getFileIcon(ext);
                        const relativePath = uploadMode === 'folder' && file.webkitRelativePath 
                            ? file.webkitRelativePath 
                            : file.name;
                        
                        html += `
                            <div class="flex items-center space-x-2 text-xs text-slate-600 bg-slate-50 p-2 rounded mb-1">
                                ${fileIcon}
                                <span class="truncate flex-1" title="${relativePath}">${relativePath}</span>
                                <span class="text-slate-400">${formatFileSize(file.size)}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                });

                filesDiv.innerHTML = html;
            } else {
                fileList.classList.add('hidden');
            }
        }

        function getFileIcon(ext) {
            const icons = {
                'java': '<svg class="w-3 h-3 flex-shrink-0 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M8.851 18.56s-.917.534.653.714c1.902.218 2.874.187 4.969-.211 0 0 .552.346 1.321.646-4.699 2.013-10.633-.118-6.943-1.149M8.276 15.933s-1.028.761.542.924c2.032.209 3.636.227 6.413-.308 0 0 .384.389.987.602-5.679 1.661-12.007.13-7.942-1.218M13.116 11.475c1.158 1.333-.304 2.533-.304 2.533s2.939-1.518 1.589-3.418c-1.261-1.772-2.228-2.652 3.007-5.688 0-.001-8.216 2.051-4.292 6.573M19.33 20.504s.679.559-.747.991c-2.712.822-11.288 1.069-13.669.033-.856-.373.75-.89 1.254-.998.527-.114.828-.093.828-.093-.953-.671-6.156 1.317-2.643 1.887 9.58 1.553 17.462-.7 14.977-1.82M9.292 13.21s-4.362 1.036-1.544 1.412c1.189.159 3.561.123 5.77-.062 1.806-.152 3.618-.477 3.618-.477s-.637.272-1.098.587c-4.429 1.165-12.986.623-10.522-.568 2.082-1.006 3.776-.892 3.776-.892M17.116 17.584c4.503-2.34 2.421-4.589.968-4.285-.355.074-.515.138-.515.138s.132-.207.385-.297c2.875-1.011 5.086 2.981-.928 4.562 0-.001.07-.062.09-.118M14.401 0s2.494 2.494-2.365 6.33c-3.896 3.077-.888 4.832-.001 6.836-2.274-2.053-3.943-3.858-2.824-5.539 1.644-2.469 6.197-3.665 5.19-7.627"/></svg>',
                'cpp': '<svg class="w-3 h-3 flex-shrink-0 text-blue-500" fill="currentColor" viewBox="0 0 24 24"><path d="M22.394 6c-.167-.29-.398-.543-.652-.69L12.926.22c-.509-.294-1.34-.294-1.848 0L2.26 5.31c-.508.293-.923 1.013-.923 1.6v10.18c0 .294.104.62.271.91.167.29.398.543.652.69l8.816 5.09c.508.293 1.34.293 1.848 0l8.816-5.09c.254-.147.485-.4.652-.69.167-.29.27-.616.27-.91V6.91c.003-.294-.1-.62-.268-.91zM12 19.11c-3.92 0-7.109-3.19-7.109-7.11 0-3.92 3.19-7.11 7.11-7.11a7.133 7.133 0 016.156 3.553l-3.076 1.78a3.567 3.567 0 00-3.08-1.78A3.56 3.56 0 008.444 12 3.56 3.56 0 0012 15.555a3.57 3.57 0 003.08-1.778l3.078 1.78A7.135 7.135 0 0112 19.11zm7.11-6.715h-.79v.79h-.79v-.79h-.79v-.79h.79v-.79h.79v.79h.79v.79zm2.962 0h-.79v.79h-.79v-.79h-.79v-.79h.79v-.79h.79v.79h.79v.79z"/></svg>',
                'cs': '<svg class="w-3 h-3 flex-shrink-0 text-purple-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zM9.426 7.12a5.55 5.55 0 011.985.38v1.181a4.5 4.5 0 00-2.025-.566 2.9 2.9 0 00-2.088.8 3.014 3.014 0 00-.817 2.217c0 .95.27 1.675.8 2.159.52.473 1.233.701 2.104.701.848 0 1.593-.21 2.013-.557v1.2a5.6 5.6 0 01-2.115.42c-1.32 0-2.35-.362-3.068-1.089-.718-.724-1.077-1.73-1.077-3.01a4.3 4.3 0 011.054-3.03c.67-.777 1.63-1.145 2.73-1.145l.504-.06zm7.236 0a5.55 5.55 0 011.985.38v1.181a4.5 4.5 0 00-2.025-.566 2.9 2.9 0 00-2.088.8 3.014 3.014 0 00-.817 2.217c0 .95.27 1.675.8 2.159.52.473 1.233.701 2.104.701.848 0 1.593-.21 2.013-.557v1.2a5.6 5.6 0 01-2.115.42c-1.32 0-2.35-.362-3.068-1.089-.718-.724-1.077-1.73-1.077-3.01a4.3 4.3 0 011.054-3.03c.67-.777 1.63-1.145 2.73-1.145l.504-.06z"/></svg>',
                'py': '<svg class="w-3 h-3 flex-shrink-0 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M14.25.18l.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98l-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95l.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25l-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"/></svg>',
                'js': '<svg class="w-3 h-3 flex-shrink-0 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0zm22.034 18.276c-.175-1.095-.888-2.015-3.003-2.873-.736-.345-1.554-.585-1.797-1.14-.091-.33-.105-.51-.046-.705.15-.646.915-.84 1.515-.66.39.12.75.42.976.9 1.034-.676 1.034-.676 1.755-1.125-.27-.42-.404-.601-.586-.78-.63-.705-1.469-1.065-2.834-1.034l-.705.089c-.676.165-1.32.525-1.71 1.005-1.14 1.291-.811 3.541.569 4.471 1.365 1.02 3.361 1.244 3.616 2.205.24 1.17-.87 1.545-1.966 1.41-.811-.18-1.26-.586-1.755-1.336l-1.83 1.051c.21.48.45.689.81 1.109 1.74 1.756 6.09 1.666 6.871-1.004.029-.09.24-.705.074-1.65l.046.067zm-8.983-7.245h-2.248c0 1.938-.009 3.864-.009 5.805 0 1.232.063 2.363-.138 2.711-.33.689-1.18.601-1.566.48-.396-.196-.597-.466-.83-.855-.063-.105-.11-.196-.127-.196l-1.825 1.125c.305.63.75 1.172 1.324 1.517.855.51 2.004.675 3.207.405.783-.226 1.458-.691 1.811-1.411.51-.93.402-2.07.397-3.346.012-2.054 0-4.109 0-6.179l.004-.056z"/></svg>'
            };
            return icons[ext] || `<svg class="w-3 h-3 flex-shrink-0 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function clearFiles() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('folderInput').value = '';
            document.getElementById('fileList').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = true;
        }

        async function uploadFiles() {
            const formData = new FormData();
            selectedFiles.forEach(file => {
                // For folder uploads, preserve the relative path
                if (uploadMode === 'folder' && file.webkitRelativePath) {
                    formData.append('files', file, file.webkitRelativePath);
                } else {
                    formData.append('files', file);
                }
            });

            const response = await fetch(`${API_URL}/upload`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.status === 'success') {
                sessionId = data.session_id;
                return true;
            }
            throw new Error(data.message || 'Upload failed');
        }

        async function analyzeFiles() {
            const resultsPanel = document.getElementById('resultsPanel');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            try {
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<div class="spinner"></div><span>Analyzing...</span>';
                
                resultsPanel.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-12 text-center border border-slate-200">
                        <div class="spinner mx-auto mb-4"></div>
                        <h3 class="text-lg font-medium text-slate-700 mb-2">Analyzing Code...</h3>
                        <p class="text-sm text-slate-500">Multi-agent detection in progress</p>
                        <p class="text-xs text-slate-400 mt-2">Analyzing ${selectedFiles.length} file(s)...</p>
                    </div>
                `;

                // Upload files
                await uploadFiles();

                // Update config
                await fetch(`${API_URL}/config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        enableClassDetection: document.getElementById('enableClass').checked,
                        enableMethodDetection: document.getElementById('enableMethod').checked,
                        enableExplanations: document.getElementById('enableExplanations').checked,
                        enableFixSuggestions: document.getElementById('enableFixes').checked,
                        applyProgramSlicing: document.getElementById('applyProgramSlicing').checked,
                        minConfidence: parseFloat(document.getElementById('minConfidence').value)
                    })
                });

                // Analyze
                const response = await fetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({session_id: sessionId})
                });

                const data = await response.json();
                if (data.status === 'success') {
                    displayResults(data);
                } else {
                    throw new Error(data.message || 'Analysis failed');
                }
            } catch (error) {
                resultsPanel.innerHTML = `
                    <div class="bg-red-50 rounded-xl shadow-lg p-12 text-center border border-red-200">
                        <svg class="w-16 h-16 mx-auto mb-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h3 class="text-lg font-medium text-red-700 mb-2">Analysis Failed</h3>
                        <p class="text-sm text-red-600">${error.message}</p>
                        <p class="text-xs text-slate-500 mt-2">Please check that the backend API is running at ${API_URL}</p>
                    </div>
                `;
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Start Analysis</span>
                `;
            }
        }

        function displayResults(data) {
            const enableExplanations = document.getElementById('enableExplanations').checked;
            const enableFixes = document.getElementById('enableFixes').checked;
            
            const severityColor = {
                'high': 'text-red-600 bg-red-50 border-red-200',
                'medium': 'text-yellow-600 bg-yellow-50 border-yellow-200',
                'low': 'text-blue-600 bg-blue-50 border-blue-200'
            };

            const resultsPanel = document.getElementById('resultsPanel');
            resultsPanel.innerHTML = `
                <div class="space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl shadow-lg p-4 border border-slate-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500">Total Issues</p>
                                    <p class="text-2xl font-bold text-slate-800">${data.summary.total_issues}</p>
                                </div>
                                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-4 border border-slate-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500">High Severity</p>
                                    <p class="text-2xl font-bold text-red-600">${data.summary.by_severity.high || 0}</p>
                                </div>
                                <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-4 border border-slate-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500">Medium Severity</p>
                                    <p class="text-2xl font-bold text-yellow-600">${data.summary.by_severity.medium || 0}</p>
                                </div>
                                <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Export Button -->
                    <button onclick="exportResults()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        <span>Export Results (JSON)</span>
                    </button>

                    <!-- Issues List -->
                    <div class="space-y-4">
                        <h2 class="text-lg font-semibold text-slate-800">Detected Issues (${data.issues.length})</h2>
                        ${data.issues.length === 0 ? `
                            <div class="bg-green-50 rounded-xl p-8 text-center border border-green-200">
                                <svg class="w-16 h-16 mx-auto mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <h3 class="text-lg font-medium text-green-700 mb-2">No Technical Debt Found!</h3>
                                <p class="text-sm text-green-600">Your code looks clean. Great job!</p>
                            </div>
                        ` : data.issues.map(issue => `
                            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                                <div class="p-5">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2 mb-1 flex-wrap">
                                                <span class="px-2 py-1 rounded text-xs font-medium border ${severityColor[issue.severity] || severityColor.low}">
                                                    ${issue.debt_type}
                                                </span>
                                                <span class="px-2 py-1 rounded text-xs font-medium bg-slate-100 text-slate-600">
                                                    ${issue.severity}
                                                </span>
                                                <span class="text-xs text-slate-500">
                                                    Confidence: ${(issue.confidence * 100).toFixed(0)}%
                                                </span>
                                            </div>
                                            <h3 class="text-base font-semibold text-slate-800">${issue.code_name}</h3>
                                            <p class="text-sm text-slate-500 mt-1">
                                                ${issue.file_path}${issue.start_line ? ` (Lines ${issue.start_line}-${issue.end_line})` : ''}
                                            </p>
                                        </div>
                                    </div>

                                    ${enableExplanations && issue.explanation ? `
                                        <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-3">
                                            <p class="text-xs font-medium text-blue-800 mb-1">Why this is technical debt:</p>
                                            <p class="text-sm text-slate-700">${issue.explanation}</p>
                                        </div>
                                    ` : ''}

                                    ${enableFixes && issue.fix_suggestion ? `
                                        <div class="bg-green-50 border border-green-100 rounded-lg p-3">
                                            <p class="text-xs font-medium text-green-800 mb-1">Suggested fix:</p>
                                            <p class="text-sm text-slate-700">${issue.fix_suggestion}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function exportResults() {
            // In a real implementation, this would fetch results from the server
            alert('Export functionality will download results as JSON');
        }

        // Show initial empty state
        document.getElementById('resultsPanel').innerHTML = `
            <div class="bg-white rounded-xl shadow-lg p-12 text-center border border-slate-200">
                <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                </svg>
                <h3 class="text-lg font-medium text-slate-600 mb-2">No Analysis Yet</h3>
                <p class="text-sm text-slate-400">Upload files or select a project folder to begin analysis</p>
                <p class="text-xs text-slate-400 mt-1">Supported: Java, C++, C#, Python, JavaScript</p>
            </div>
        `;

        // Sample data for each category
        const smells = {
            classLevel: [
                "Blob (God Class)",
                "Data Class",
            ],
            methodLevel: [
                "Feature Envy",
                "Long Method",
            ],
            otherSmells: [
                "Deeply Nested Control Flow",
                "Collapsible If Statements",
                "Duplicated String Literals",
                "Duplicated Code Blocks",
                "Long Parameter List",
                "Empty Methods"
            ],
            securitySmells: [
                "Hardcoded Secrets",
                "Lack of Input Validation",
                "Insufficient Error Handling",
                "CSRF Vulnerabilities"
            ]
        };

        // Function to dynamically populate the lists
        function populateCodeSmells() {
            const classSmellsList = document.getElementById("classSmellsList");
            const methodSmellsList = document.getElementById("methodSmellsList");
            const otherSmellsList = document.getElementById("otherSmellsList");
            const securitySmellsList = document.getElementById("securitySmellsList");

            // Clear any existing content
            classSmellsList.innerHTML = "";
            methodSmellsList.innerHTML = "";
            otherSmellsList.innerHTML = "";
            securitySmellsList.innerHTML = "";

            // Populate class-level smells
            smells.classLevel.forEach(smell => {
                const li = document.createElement("li");
                li.textContent = `• ${smell}`;
                classSmellsList.appendChild(li);
            });

            // Populate method-level smells
            smells.methodLevel.forEach(smell => {
                const li = document.createElement("li");
                li.textContent = `• ${smell}`;
                methodSmellsList.appendChild(li);
            });

            // Populate other smells
            smells.otherSmells.forEach(smell => {
                const li = document.createElement("li");
                li.textContent = `• ${smell}`;
                otherSmellsList.appendChild(li);
            });

            // Populate security smells
            smells.securitySmells.forEach(smell => {
                const li = document.createElement("li");
                li.textContent = `• ${smell}`;
                securitySmellsList.appendChild(li);
            });
        }

        // Call the function to populate the code smells when the page loads
        document.addEventListener("DOMContentLoaded", function() {
            populateCodeSmells();
        });
    </script>
</body>
</html>